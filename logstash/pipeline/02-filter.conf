# =============================================================================
# Logstash Filter Configuration
# =============================================================================
# Obrada i transformacija logova
# =============================================================================

filter {
  # -------------------------------------------------------------------------
  # Dodaj timestamp ako ne postoji
  # -------------------------------------------------------------------------
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # -------------------------------------------------------------------------
  # Obrada aplikacijskih logova
  # -------------------------------------------------------------------------
  if "application" in [tags] {
    # Parsiranje JSON aplikacijskih logova
    if [message] =~ /^\{.*\}$/ {
      json {
        source => "message"
        target => "app_data"
      }
    }
    
    # Dodaj sigurnosnu kategoriju
    if [app_data][event_type] == "auth" {
      mutate {
        add_field => { "security_category" => "authentication" }
      }
      
      # Označi neuspjele prijave
      if [app_data][status] == "failed" {
        mutate {
          add_field => { "security_severity" => "warning" }
          add_tag => ["auth_failure"]
        }
      }
    }
    
    # Otkrivanje potencijalnog log injection napada
    if [message] =~ /[\r\n]/ or [app_data][message] =~ /[\r\n]/ {
      mutate {
        add_tag => ["potential_log_injection"]
        add_field => { "security_severity" => "high" }
        add_field => { "security_category" => "attack_detected" }
      }
    }
  }

  # -------------------------------------------------------------------------
  # Obrada syslog poruka
  # -------------------------------------------------------------------------
  if "syslog" in [tags] {
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" 
      }
    }
    
    # Otkrivanje SSH napada
    if [syslog_program] == "sshd" {
      if [syslog_message] =~ /Failed password/ {
        mutate {
          add_tag => ["ssh_auth_failure"]
          add_field => { "security_category" => "authentication" }
          add_field => { "security_severity" => "warning" }
        }
      }
      
      if [syslog_message] =~ /Invalid user/ {
        mutate {
          add_tag => ["ssh_invalid_user"]
          add_field => { "security_category" => "authentication" }
          add_field => { "security_severity" => "high" }
        }
      }
    }
  }

  # -------------------------------------------------------------------------
  # GeoIP obogaćivanje
  # -------------------------------------------------------------------------
  if [source_ip] and [source_ip] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[0-1])\.|192\.168\.|127\.)/ {
    geoip {
      source => "source_ip"
      target => "geoip"
    }
  }

  # -------------------------------------------------------------------------
  # Ukloni nepotrebna polja
  # -------------------------------------------------------------------------
  mutate {
    remove_field => ["host", "@version"]
  }
}
